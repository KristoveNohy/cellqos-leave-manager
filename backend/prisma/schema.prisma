generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  EMPLOYEE
  MANAGER

  @@map("user_role")
}

enum LeaveType {
  ANNUAL_LEAVE
  SICK_LEAVE
  HOME_OFFICE
  UNPAID_LEAVE
  OTHER

  @@map("leave_type")
}

enum LeaveStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  CANCELLED

  @@map("leave_status")
}

model Team {
  id                  BigInt   @id @default(autoincrement())
  name                String   @unique
  maxConcurrentLeaves Int?     @map("max_concurrent_leaves")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  users               User[]

  @@map("teams")
}

model User {
  id                 String   @id
  email              String   @unique
  name               String
  role               UserRole @default(EMPLOYEE)
  teamId             BigInt?  @map("team_id")
  team               Team?    @relation(fields: [teamId], references: [id])
  employmentStartDate DateTime? @map("employment_start_date") @db.Date
  birthDate          DateTime? @map("birth_date") @db.Date
  hasChild           Boolean  @default(false) @map("has_child")
  manualLeaveAllowanceDays Float? @map("manual_leave_allowance_days")
  isActive           Boolean  @default(true) @map("is_active")
  passwordHash       String?  @map("password_hash")
  magicLinkTokenHash String?  @map("magic_link_token_hash")
  magicLinkExpiresAt DateTime? @map("magic_link_expires_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  leaveRequests      LeaveRequest[] @relation("UserLeaveRequests")
  approvals          LeaveRequest[] @relation("UserApprovals")
  leaveBalances      LeaveBalance[]
  notifications      Notification[]

  @@map("users")
}

model LeaveRequest {
  id             BigInt      @id @default(autoincrement())
  userId         String      @map("user_id")
  user           User        @relation("UserLeaveRequests", fields: [userId], references: [id])
  type           LeaveType
  startDate      DateTime    @map("start_date")
  endDate        DateTime    @map("end_date")
  isHalfDayStart Boolean     @default(false) @map("is_half_day_start")
  isHalfDayEnd   Boolean     @default(false) @map("is_half_day_end")
  status         LeaveStatus @default(DRAFT)
  reason         String?
  managerComment String?     @map("manager_comment")
  approvedBy     String?     @map("approved_by")
  approver       User?       @relation("UserApprovals", fields: [approvedBy], references: [id])
  approvedAt     DateTime?   @map("approved_at")
  computedDays   Float       @default(0) @map("computed_days")
  attachmentUrl  String?     @map("attachment_url")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  @@map("leave_requests")
}

model Holiday {
  id               BigInt   @id @default(autoincrement())
  date             DateTime @unique
  name             String
  isCompanyHoliday Boolean  @default(true) @map("is_company_holiday")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("holidays")
}

model LeaveBalance {
  id            BigInt   @id @default(autoincrement())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id])
  year          Int
  allowanceDays Float    @default(0) @map("allowance_days")
  usedDays      Float    @default(0) @map("used_days")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([userId, year])
  @@map("leave_balances")
}

model AuditLog {
  id          BigInt   @id @default(autoincrement())
  actorUserId String   @map("actor_user_id")
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  action      String
  beforeJson  Json?    @map("before_json")
  afterJson   Json?    @map("after_json")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("audit_logs")
}

model Notification {
  id          BigInt   @id @default(autoincrement())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id])
  type        String
  payloadJson Json     @map("payload_json")
  dedupeKey   String?  @unique @map("dedupe_key")
  sentAt      DateTime? @map("sent_at")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

model Setting {
  id                         Int      @id @default(1)
  showTeamCalendarForEmployees Boolean  @default(false) @map("show_team_calendar_for_employees")
  annualLeaveAccrualPolicy   String   @default("YEAR_START") @map("annual_leave_accrual_policy")
  carryOverEnabled           Boolean  @default(false) @map("carry_over_enabled")
  carryOverLimitDays         Float    @default(0) @map("carry_over_limit_days")
  updatedAt                  DateTime @default(now()) @map("updated_at")

  @@map("settings")
}
